<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Agenda - Compromissos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #f7f7f7;
    }
    .header {
      background-color: #4CAF50;
      color: white;
      padding: 20px;
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      border-radius: 0 0 20px 20px;
    }
    .header i { margin-right: 10px; }
    .mode-selector {
      display: flex;
      justify-content: center;
      margin-top: 15px;
      gap: 10px;
    }
    .mode-selector button {
      border: none;
      border-radius: 20px;
      padding: 10px 20px;
      background: #ccc;
      color: #333;
      font-size: 16px;
      cursor: pointer;
    }
    .mode-selector .active {
      background-color: #b04c7d;
      color: white;
    }
    .section-title {
      text-align: center;
      margin: 20px 0 10px;
      color: #888;
      font-weight: bold;
    }
    .agenda-container {
      max-width: 500px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .dia { margin-bottom: 20px; }
    .dia h3 {
      margin: 0 0 10px;
      color: #666;
      font-size: 18px;
    }
    .compromissos {
      border: 1px solid #bbb;
      border-radius: 10px;
      padding: 10px 15px;
      background-color: #fdfdfd;
    }
    .compromissos p {
      margin: 5px 0;
      font-size: 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .compromissos p .status {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .add-button {
      position: fixed;
      bottom: 25px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      font-size: 26px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      cursor: pointer;
    }
    .add-button:hover { background-color: #45a049; }
    .modal {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: white;
      margin: 10% auto;
      padding: 20px;
      border-radius: 10px;
      max-width: 400px;
    }
    .modal-content input, .modal-content textarea {
      width: 100%;
      margin-bottom: 10px;
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    .realizado-btn {
      background: none;
      border: none;
      color: green;
      cursor: pointer;
      font-size: 16px;
    }
    #loading {
      display: none;
      text-align: center;
      padding: 30px;
      font-size: 18px;
      color: #888;
    }
  </style>
</head>
<body>
  <div class="header">
    <i class="fa-solid fa-calendar-days"></i> Compromissos
  </div>
  <div class="mode-selector">
    <button class="modo" onclick="carregar('dia')">Dia</button>
    <button class="modo" onclick="carregar('semana')">Semana</button>
    <button class="modo" onclick="carregar('mes')">Mês</button>
    <button class="modo" onclick="carregar('ano')">Ano</button>
  </div>
  <div class="section-title" id="tituloVisualizacao">Meus compromissos</div>
  <div id="loading">
    <i class="fa-solid fa-spinner fa-spin" style="font-size:28px;"></i><br>
    Carregando compromissos...
  </div>
  <div class="agenda-container" id="agenda"></div>

  <button class="add-button" onclick="document.getElementById('modal').style.display='block'">
    <i class="fa-solid fa-plus"></i>
  </button>

  <div class="modal" id="modal">
    <div class="modal-content">
      <h3>Novo compromisso</h3>
      <input type="date" id="data">
      <input type="time" id="hora">
      <input type="text" id="titulo" placeholder="Título">
      <textarea id="descricao" placeholder="Descrição"></textarea>
      <button onclick="salvarCompromisso()">Salvar</button>
      <button onclick="document.getElementById('modal').style.display='none'">Cancelar</button>
    </div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxD9LMBBP1axfAz7jSHaUic6c-juUaLuwcPWvZoqnVJn_VwXaLmHVsZoLRefdKx_lkVNg/exec";

    function carregar(filtro = 'semana') {
      document.getElementById('tituloVisualizacao').innerText = `Meus compromissos de ${filtro}`;
      document.querySelectorAll('.modo').forEach(btn => {
        btn.classList.remove('active');
        if (btn.innerText.normalize("NFD").replace(/[̀-ͯ]/g, "").toLowerCase() === filtro)
          btn.classList.add('active');
      });

      document.getElementById("agenda").style.display = "none";
      document.getElementById("loading").style.display = "block";

      fetch(API_URL)
        .then(r => r.json())
        .then(dados => {
          const container = document.getElementById('agenda');
          container.innerHTML = '';
          const hoje = new Date();
          const inicioSemana = new Date(hoje);
          inicioSemana.setDate(hoje.getDate() - hoje.getDay() + 1);
          const fimSemana = new Date(inicioSemana);
          fimSemana.setDate(inicioSemana.getDate() + 6);
          const mesAtual = hoje.getMonth();
          const anoAtual = hoje.getFullYear();

          const agrupados = {};

          dados.forEach(item => {
            const partes = item.data.split("T")[0].split("-");
            const dataKey = partes.join("-");
            const dataObj = new Date(dataKey + "T00:00:00");

            let incluir = false;
            if (filtro === 'dia') {
              incluir = dataObj.toDateString() === hoje.toDateString();
            } else if (filtro === 'semana') {
              incluir = dataObj >= inicioSemana && dataObj <= fimSemana;
            } else if (filtro === 'mes') {
              incluir = dataObj.getMonth() === mesAtual && dataObj.getFullYear() === anoAtual;
            } else if (filtro === 'ano') {
              incluir = dataObj.getFullYear() === anoAtual;
            }

            if (incluir) {
              if (!agrupados[dataKey]) agrupados[dataKey] = [];
              agrupados[dataKey].push(item);
            }
          });

          if (filtro === 'ano') {
            const mesesAgrupados = {};
            Object.keys(agrupados).forEach(data => {
              const dataObj = new Date(data + "T00:00:00");
              const mes = dataObj.toLocaleDateString('pt-BR', { month: 'long' });
              if (!mesesAgrupados[mes]) mesesAgrupados[mes] = [];
              mesesAgrupados[mes] = mesesAgrupados[mes].concat(agrupados[data]);
            });

            for (const mes in mesesAgrupados) {
              const compromissosHtml = mesesAgrupados[mes].map(c => {
                const dataObj = new Date(c.data);
                const dataFormatada = dataObj.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });

                let hora = c.hora;
                if (typeof c.hora === 'string' && c.hora.includes('T')) {
                  const h = new Date(c.hora);
                  if (!isNaN(h)) {
                    hora = h.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                  }
                }

                const statusIcon = c.status === 'realizado'
                  ? '<i class="fa-solid fa-circle-check" style="color:green;"></i>'
                  : '<i class="fa-regular fa-clock"></i>';

                return `<p><span class='status'>${statusIcon} <b>${hora}</b> - ${c.titulo}</span> (${dataFormatada})</p>`;
              }).join('');

              const mesDiv = document.createElement('div');
              mesDiv.className = 'dia';
              mesDiv.innerHTML = `<h3>${mes}</h3><div class='compromissos'>${compromissosHtml}</div>`;
              container.appendChild(mesDiv);
            }

          } else if (filtro === 'mes') {
            const semanasAgrupadas = {};
            Object.keys(agrupados).forEach(data => {
              const dataObj = new Date(data + "T00:00:00");
              const diaDoMes = dataObj.getDate();
              const semana = Math.ceil(diaDoMes / 7);
              const key = `Semana ${semana}`;
              if (!semanasAgrupadas[key]) semanasAgrupadas[key] = [];
              semanasAgrupadas[key] = semanasAgrupadas[key].concat(agrupados[data]);
            });

            for (const semana in semanasAgrupadas) {
              const compromissosHtml = semanasAgrupadas[semana].map(c => {
                let hora = c.hora;
                if (typeof c.hora === 'string' && c.hora.includes('T')) {
                  const h = new Date(c.hora);
                  if (!isNaN(h)) hora = h.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                }
                const statusIcon = c.status === 'realizado'
                  ? '<i class="fa-solid fa-circle-check" style="color:green;"></i>'
                  : '<i class="fa-regular fa-clock"></i>';
                const btn = c.status === 'realizado' ? '' : `<button class='realizado-btn'>Realizado</button>`;
                return `<p><span class='status'>${statusIcon} <b>${hora}</b> - ${c.titulo}</span> ${btn}</p>`;
              }).join('');

              const semanaDiv = document.createElement('div');
              semanaDiv.className = 'dia';
              semanaDiv.innerHTML = `<h3>${semana}</h3><div class='compromissos'>${compromissosHtml}</div>`;
              container.appendChild(semanaDiv);
            }

          } else {
            for (const data in agrupados) {
              const dataObj = new Date(data + "T00:00:00");
              const dataFormatada = dataObj.toLocaleDateString('pt-BR', {
                weekday: 'long', day: '2-digit', month: '2-digit', year: 'numeric'
              });

              const compromissosHtml = agrupados[data].map((c, i) => {
                let hora = c.hora;
                if (typeof c.hora === 'string' && c.hora.includes('T')) {
                  const h = new Date(c.hora);
                  if (!isNaN(h)) hora = h.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                }
                const statusIcon = c.status === 'realizado'
                  ? '<i class="fa-solid fa-circle-check" style="color:green;"></i>'
                  : '<i class="fa-regular fa-clock"></i>';
                const btn = c.status === 'realizado' ? '' :
                  `<button class='realizado-btn'>Realizado</button>`;
                return `<p><span class='status'>${statusIcon} <b>${hora}</b> - ${c.titulo}</span> ${btn}</p>`;
              }).join('');

              const diaDiv = document.createElement('div');
              diaDiv.className = 'dia';
              diaDiv.innerHTML = `<h3>${dataFormatada}</h3><div class='compromissos'>${compromissosHtml}</div>`;
              container.appendChild(diaDiv);
            }
          }

          document.getElementById("loading").style.display = "none";
          container.style.display = "block";
        });
    }

    function salvarCompromisso() {
      const data = document.getElementById('data').value;
      const hora = document.getElementById('hora').value;
      const titulo = document.getElementById('titulo').value;
      const descricao = document.getElementById('descricao').value;

      fetch(API_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ data, hora, titulo, descricao, status: 'pendente' })
      });

      document.getElementById('modal').style.display = 'none';
      setTimeout(() => carregar(), 1000);
    }

    window.onload = () => carregar();
  </script>
</body>
</html>
